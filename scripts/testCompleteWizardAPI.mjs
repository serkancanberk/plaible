#!/usr/bin/env node

// Test script for complete New Story Wizard API flow
// Tests the entire flow from API generation to database storage

const API_BASE = 'http://localhost:3000/api';

async function testCompleteWizardAPI() {
  console.log("üß™ Testing Complete New Story Wizard API Flow");
  console.log("=============================================");
  
  const testData = {
    title: "The Great Gatsby",
    authorName: "F. Scott Fitzgerald",
    publishedYear: 1925,
    mainCategory: "book"
  };
  
  console.log("\nüìù Test Data:");
  console.log(JSON.stringify(testData, null, 2));
  
  try {
    // Step 1: Test generate endpoint (preview step)
    console.log("\nüé≠ Step 1: Testing generate endpoint (preview step)...");
    
    const generateResponse = await fetch(`${API_BASE}/admin/stories/generate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(testData)
    });
    
    console.log("üìä Generate Response Status:", generateResponse.status);
    
    if (generateResponse.ok) {
      const generateResult = await generateResponse.json();
      console.log("‚úÖ Generate successful!");
      console.log("üìä Generated document validation:");
      
      const story = generateResult.story;
      
      // Validate complete Story document structure
      const requiredFields = [
        '_id', 'slug', 'mainCategory', 'subCategory', 'title', 'authorName', 
        'publisher', 'genres', 'storySettingTime', 'publishedYear', 'headline', 
        'description', 'language', 'license', 'contentRating', 'tags', 'assets',
        'characters', 'roles', 'cast', 'hooks', 'summary', 'funFacts', 'stats',
        'share', 'feedbacks', 'pricing', 'relatedStoryIds', 'reengagementTemplates',
        'storyrunner', 'createdAt', 'updatedAt', 'isActive'
      ];
      
      const missingFields = requiredFields.filter(field => !(field in story));
      if (missingFields.length === 0) {
        console.log("‚úÖ All required fields present");
      } else {
        console.log("‚ùå Missing required fields:", missingFields);
      }
      
      // Validate specific structures
      console.log("\nüîç Structure Validation:");
      console.log("- _id format:", story._id?.startsWith('story_') ? '‚úÖ' : '‚ùå', story._id);
      console.log("- slug format:", story.slug?.includes('-') ? '‚úÖ' : '‚ùå', story.slug);
      console.log("- mainCategory:", ['book', 'story', 'biography'].includes(story.mainCategory) ? '‚úÖ' : '‚ùå', story.mainCategory);
      console.log("- subCategory:", !!story.subCategory ? '‚úÖ' : '‚ùå', story.subCategory);
      console.log("- characters array:", Array.isArray(story.characters) ? '‚úÖ' : '‚ùå', story.characters?.length || 0, 'characters');
      console.log("- roles array:", Array.isArray(story.roles) ? '‚úÖ' : '‚ùå', story.roles?.length || 0, 'roles');
      console.log("- cast array:", Array.isArray(story.cast) ? '‚úÖ' : '‚ùå', story.cast?.length || 0, 'cast entries');
      console.log("- storyrunner object:", typeof story.storyrunner === 'object' ? '‚úÖ' : '‚ùå');
      
      // Validate role IDs
      if (story.roles && story.cast) {
        const roleIds = new Set(story.roles.map(r => r.id));
        const characterIds = new Set(story.characters?.map(c => c.id) || []);
        
        console.log("\nüé≠ Role & Cast Validation:");
        console.log("- Role IDs:", roleIds.has('role_hero') && roleIds.has('role_villain') && roleIds.has('role_side') && roleIds.has('role_other') ? '‚úÖ' : '‚ùå');
        
        let castValid = true;
        for (const castItem of story.cast) {
          if (!characterIds.has(castItem.characterId)) {
            console.log(`‚ùå Cast references unknown character: ${castItem.characterId}`);
            castValid = false;
          }
          for (const roleId of castItem.roleIds || []) {
            if (!roleIds.has(roleId)) {
              console.log(`‚ùå Cast references unknown role: ${roleId}`);
              castValid = false;
            }
          }
        }
        console.log("- Cast consistency:", castValid ? '‚úÖ' : '‚ùå');
      }
      
      // Validate storyrunner structure
      if (story.storyrunner) {
        console.log("\nü§ñ StoryRunner Validation:");
        console.log("- systemPrompt:", !!story.storyrunner.systemPrompt ? '‚úÖ' : '‚ùå');
        console.log("- storyPrompt:", !!story.storyrunner.storyPrompt ? '‚úÖ' : '‚ùå');
        console.log("- guardrails:", Array.isArray(story.storyrunner.guardrails) ? '‚úÖ' : '‚ùå', story.storyrunner.guardrails?.length || 0, 'items');
        console.log("- openingBeats:", Array.isArray(story.storyrunner.openingBeats) ? '‚úÖ' : '‚ùå', story.storyrunner.openingBeats?.length || 0, 'items');
        console.log("- editableFinalPrompt:", !!story.storyrunner.editableFinalPrompt ? '‚úÖ' : '‚ùå');
        
        // Check storyPrompt sections
        const storyPrompt = story.storyrunner.storyPrompt || '';
        const requiredSections = [
          '## About Plaible',
          '## How to Play', 
          '## StoryRunner AI Role',
          '## Story Essentials',
          '## Available Characters',
          '## Player\'s Selections',
          '## Safety Guardrails',
          '## Instructions'
        ];
        
        const missingSections = requiredSections.filter(section => !storyPrompt.includes(section));
        console.log("- StoryPrompt sections:", missingSections.length === 0 ? '‚úÖ' : '‚ùå', missingSections.length === 0 ? 'All present' : `Missing: ${missingSections.join(', ')}`);
      }
      
      // Validate content focus
      console.log("\nüéÆ Interactive Focus Validation:");
      const hasInteractiveHeadline = story.headline?.toLowerCase().includes('step into') || 
                                    story.headline?.toLowerCase().includes('your') ||
                                    story.headline?.toLowerCase().includes('play');
      const hasInteractiveDescription = story.description?.toLowerCase().includes('step into') || 
                                       story.description?.toLowerCase().includes('choose') ||
                                       story.description?.toLowerCase().includes('you');
      
      console.log("- Interactive headline:", hasInteractiveHeadline ? '‚úÖ' : '‚ö†Ô∏è', `"${story.headline?.substring(0, 50)}..."`);
      console.log("- Interactive description:", hasInteractiveDescription ? '‚úÖ' : '‚ö†Ô∏è', `"${story.description?.substring(0, 50)}..."`);
      
      // Validate time setting
      console.log("\n‚è∞ Time Setting Validation:");
      console.log("- storySettingTime (time only):", story.storySettingTime && !story.storySettingTime.includes(',') && !story.storySettingTime.includes(' in ') ? '‚úÖ' : '‚ùå', `"${story.storySettingTime}"`);
      
      // Step 2: Test create endpoint (save step)
      console.log("\nüíæ Step 2: Testing create endpoint (save step)...");
      
      const createResponse = await fetch(`${API_BASE}/admin/stories`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(story) // Send the complete document as-is
      });
      
      console.log("üìä Create Response Status:", createResponse.status);
      
      if (createResponse.ok) {
        const createResult = await createResponse.json();
        console.log("‚úÖ Create successful!");
        console.log("üìä Story ID:", createResult.storyId);
        
        // Step 3: Test retrieving the created story
        console.log("\nüìñ Step 3: Testing story retrieval...");
        
        const getResponse = await fetch(`${API_BASE}/admin/stories/${createResult.storyId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        console.log("üìä Get Response Status:", getResponse.status);
        
        if (getResponse.ok) {
          const storyResult = await getResponse.json();
          console.log("‚úÖ Story retrieval successful!");
          console.log("üìä Retrieved story validation:");
          
          const savedStory = storyResult.story;
          console.log("- title:", savedStory.title);
          console.log("- authorName:", savedStory.authorName);
          console.log("- publishedYear:", savedStory.publishedYear);
          console.log("- mainCategory:", savedStory.mainCategory);
          console.log("- subCategory:", savedStory.subCategory);
          console.log("- headline:", !!savedStory.headline);
          console.log("- description:", !!savedStory.description);
          console.log("- storySettingTime:", savedStory.storySettingTime);
          console.log("- characters:", savedStory.characters?.length || 0);
          console.log("- roles:", savedStory.roles?.length || 0);
          console.log("- cast:", savedStory.cast?.length || 0);
          console.log("- hooks:", savedStory.hooks?.length || 0);
          console.log("- storyrunner:", !!savedStory.storyrunner);
          console.log("- genres:", savedStory.genres?.length || 0);
          console.log("- tags:", savedStory.tags?.length || 0);
          console.log("- summary:", !!savedStory.summary);
          console.log("- funFacts:", !!savedStory.funFacts);
          
          // Validate that all generated content was properly saved
          console.log("\nüîç Database Integration Validation:");
          const dbFields = ['headline', 'description', 'storySettingTime', 'subCategory', 'characters', 'roles', 'cast', 'hooks', 'storyrunner', 'genres', 'tags', 'summary', 'funFacts'];
          const missingDbFields = dbFields.filter(field => !savedStory[field]);
          
          if (missingDbFields.length === 0) {
            console.log("‚úÖ All generated fields properly saved to database");
          } else {
            console.log("‚ùå Missing fields in database:", missingDbFields);
          }
          
          // Check storyrunner structure
          if (savedStory.storyrunner) {
            console.log("- storyPrompt:", !!savedStory.storyrunner.storyPrompt);
            console.log("- guardrails:", savedStory.storyrunner.guardrails?.length || 0);
            console.log("- openingBeats:", savedStory.storyrunner.openingBeats?.length || 0);
            console.log("- editableFinalPrompt:", !!savedStory.storyrunner.editableFinalPrompt);
          }
          
          console.log("\nüéâ Complete wizard flow test successful!");
          console.log("üìä Story can now be edited in the admin dashboard");
          console.log("üîó Story ID for testing:", createResult.storyId);
          
        } else {
          const errorText = await getResponse.text();
          console.log("‚ùå Story retrieval failed!");
          console.log("üìä Error response:", errorText);
        }
        
      } else {
        const errorText = await createResponse.text();
        console.log("‚ùå Create failed!");
        console.log("üìä Error response:", errorText);
      }
      
    } else {
      const errorText = await generateResponse.text();
      console.log("‚ùå Generate failed!");
      console.log("üìä Error response:", errorText);
    }
    
  } catch (error) {
    console.error("‚ùå Test failed:", error.message);
    if (error.code === 'ECONNREFUSED') {
      console.log("üí° Make sure the server is running on localhost:3000");
    }
  }
  
  console.log("\nüèÅ Test completed!");
}

// Run the test
testCompleteWizardAPI().catch(console.error);
